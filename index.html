<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="app-title">ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø²Ø¨Ø§Ù† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --card-bg: rgba(255, 255, 255, 0.75);
      --border-color: rgba(0, 0, 0, 0.08);
      --shadow-color: rgba(50, 50, 93, 0.1);
      --text-main: #1f2937;
      --text-light: #4b5563;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: #f9fafb;
      background-image:
        radial-gradient(circle at 12% 18%, rgb(215, 227, 255) 0%, transparent 42%),
        radial-gradient(circle at 88% 85%, rgb(253, 224, 235) 0%, transparent 45%);
      color: var(--text-main);
    }
    .glass {
      backdrop-filter: saturate(180%) blur(12px);
      background: rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid var(--border-color);
    }
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: 1.25rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 30px -10px var(--shadow-color);
    }
    .result-item {
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      overflow: hidden;
      transition: all 0.3s ease;
      background: rgba(255,255,255,.9);
    }
    .result-item:hover { box-shadow: 0 8px 26px -10px rgba(2,6,23,.12); }
    .result-header {
      cursor: pointer;
      padding: 1rem 1.25rem;
      background: rgba(249, 250, 251, 0.6);
      transition: background 0.2s;
    }
    .result-header:hover { background: rgba(243, 244, 246, 0.85); }
    .result-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, border-color 0.5s ease-in-out;
      padding: 0 1.5rem;
      border-top: 1px solid transparent;
    }
    .result-details.open {
      max-height: 1500px;
      padding: 1.25rem 1.5rem 1.5rem;
      border-top-color: var(--border-color);
    }
    .chip {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      padding: 0.18rem 0.6rem;
      font-size: 0.78rem;
      background: #fff;
      font-weight: 600;
    }
    .chip.tag { background: #f8fafc; }
    .tag-palette-1 { background:#eef2ff; border-color:#e0e7ff; }
    .tag-palette-2 { background:#ecfeff; border-color:#cffafe; }
    .tag-palette-3 { background:#fefce8; border-color:#fde68a; }
    .tag-palette-4 { background:#f0fdf4; border-color:#bbf7d0; }
    .tag-palette-5 { background:#fff7ed; border-color:#fed7aa; }
    .drop-zone { border: 2px dashed #d1d5db; border-radius: 1rem; transition: all 0.2s ease; }
    .drop-zone.drag-over { border-color: var(--primary-color); background: #eff6ff; }
    .btn {
      border-radius: 0.75rem;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid transparent;
    }
    .btn-primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); box-shadow: 0 4px 14px -4px var(--primary-color); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: #fff; color: var(--text-light); border-color: var(--border-color); }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
    .loader {
      border: 5px solid #e5e7eb;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    select, textarea {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        transition: box-shadow 0.2s;
        background: #fff;
    }
    select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
        border-color: var(--primary-color);
    }
    .muted { color:#6b7280 }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-20 glass">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M12 2a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M12 18a3 3 0 0 0 3-3V9a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3Z"/><path d="M18 12a3 3 0 0 0-3-3V5a3 3 0 0 0-6 0v4a3 3 0 0 0 0 6v4a3 3 0 0 0 6 0v-4a3 3 0 0 0-3-3Z"/><path d="M6 12a3 3 0 0 0-3-3V5a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3v4a3 3 0 0 0 3 3v-4a3 3 0 0 0-3-3Z"/></svg>
        <h1 id="main-title" class="text-xl md:text-2xl font-bold text-gray-800">Ø³Ø§Ø²Ù†Ø¯Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
      </div>
      <div class="flex items-center gap-2">
        <select id="ui-lang-switcher" class="px-2 py-1.5 bg-white rounded-lg border border-gray-200 text-sm">
          <option value="fa">ÙØ§Ø±Ø³ÛŒ</option><option value="en">English</option>
          <option value="de">Deutsch</option><option value="fr">FranÃ§ais</option>
          <option value="es">EspaÃ±ol</option><option value="zh">ä¸­æ–‡</option>
          <option value="tr">TÃ¼rkÃ§e</option><option value="it">Italiano</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
        </select>
        <button id="stop-tts" class="btn btn-secondary p-2.5" title="ØªÙˆÙ‚Ù Ú¯ÙØªØ§Ø±" aria-label="ØªÙˆÙ‚Ù Ú¯ÙØªØ§Ø±">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Setup -->
    <section id="setup-view" class="card p-6 md:p-8">
      <p id="subtitle" class="text-gray-600 mb-6 text-lg">
        Ø²Ø¨Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…ØªÙ† ÛŒØ§ ÙÙ‡Ø±Ø³Øª ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
      </p>

      <!-- selectors -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label id="source-lang-label" class="block text-sm font-medium mb-1 text-gray-700">Ø²Ø¨Ø§Ù† Ù…Ø§Ø¯Ø±ÛŒ Ù…Ù†</label>
          <select id="source-lang" class="w-full p-2.5">
            <option>Persian</option><option>English</option><option>German</option>
            <option>French</option><option>Spanish</option><option>Chinese</option>
            <option>Turkish</option><option>Italian</option><option>Russian</option>
          </select>
        </div>
        <div>
          <label id="target-lang-label" class="block text-sm font-medium mb-1 text-gray-700">Ø²Ø¨Ø§Ù†ÛŒ Ú©Ù‡ ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…</label>
          <select id="target-lang" class="w-full p-2.5">
            <option>English</option><option>German</option><option>French</option>
            <option>Spanish</option><option>Persian</option><option>Chinese</option>
            <option>Turkish</option><option>Italian</option><option>Russian</option>
          </select>
        </div>
        <div>
          <label id="user-level-label" class="block text-sm font-medium mb-1 text-gray-700">Ø³Ø·Ø­ Ù…Ù† (Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†/ÙØ§ÛŒÙ„)</label>
          <select id="user-level" class="w-full p-2.5">
            <option id="level-unspecified" value="Unspecified">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</option>
            <option id="level-a1" value="A1 (Beginner)">A1 (Ù…Ø¨ØªØ¯ÛŒ)</option>
            <option id="level-a2" value="A2 (Elementary)">A2 (Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ)</option>
            <option id="level-b1" value="B1 (Intermediate)">B1 (Ù…ØªÙˆØ³Ø·)</option>
            <option id="level-b2" value="B2 (Upper-Intermediate)">B2 (ÙÙˆÙ‚ Ù…ØªÙˆØ³Ø·)</option>
            <option id="level-c1" value="C1 (Advanced)">C1 (Ù¾ÛŒØ´Ø±ÙØªÙ‡)</option>
          </select>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input id="force-wordlist" type="checkbox" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500">
            <span id="force-wordlist-label" class="text-sm">Ø§ÛŒÙ† ÙˆØ±ÙˆØ¯ÛŒ ÛŒÚ© Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡ Ø§Ø³Øª</span>
          </label>
        </div>
      </div>

      <!-- guidance -->
      <div id="hint-container" class="text-sm text-blue-800 bg-blue-50 border border-blue-200 rounded-xl p-4 mb-5">
        <span id="hint"></span>
      </div>

      <!-- input -->
      <div id="drop-zone" class="drop-zone p-4">
        <textarea id="text-input" rows="10" class="w-full p-3 bg-transparent focus:bg-white" placeholder=""></textarea>
        <div class="flex flex-col md:flex-row gap-3 md:items-center justify-between mt-4">
          <div class="flex items-center gap-2">
            <label for="file-upload" class="cursor-pointer btn btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <span id="upload-btn-text"></span>
            </label>
            <input id="file-upload" type="file" class="hidden" accept=".txt,.srt">
            <span id="file-name" class="text-sm text-gray-500"></span>
          </div>
          <button id="process-btn" class="btn btn-primary px-8 py-3 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
            <span class="select-none"></span>
          </button>
        </div>
        <p id="error-msg" class="text-red-600 text-sm mt-3 text-center hidden"></p>
      </div>
    </section>

    <!-- Results -->
    <section id="results-view" class="hidden mt-10">
      <div class="flex flex-col md:flex-row gap-3 md:items-center justify-between mb-6">
        <h2 id="results-title" class="text-3xl md:text-4xl font-bold">Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„</h2>
        <div class="flex gap-2">
          <button id="expand-all" class="btn btn-secondary"></button>
          <button id="collapse-all" class="btn btn-secondary"></button>
          <button id="start-over-btn" class="btn btn-secondary"></button>
        </div>
      </div>
      <div id="loader" class="flex justify-center items-center p-16 hidden"><div class="loader"></div></div>
      <div id="results-list" class="space-y-4"></div>
    </section>
  </main>
 
  <footer class="text-center p-8 mt-8 text-gray-500 text-sm">
      <p id="footer-text">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</p>
  </footer>

  <script>
    const PROXY_URL = 'https://language-learner.qaderi.workers.dev/';

    const setupView = document.getElementById('setup-view');
    const resultsView = document.getElementById('results-view');
    const processBtn = document.getElementById('process-btn');
    const startOverBtn = document.getElementById('start-over-btn');
    const textInput = document.getElementById('text-input');
    const fileUpload = document.getElementById('file-upload');
    const fileNameEl = document.getElementById('file-name');
    const errorMsg = document.getElementById('error-msg');
    const userLevelSelect = document.getElementById('user-level');
    const sourceLangSelect = document.getElementById('source-lang');
    const targetLangSelect = document.getElementById('target-lang');
    const loader = document.getElementById('loader');
    const resultsList = document.getElementById('results-list');
    const uiLangSwitcher = document.getElementById('ui-lang-switcher');
    const dropZone = document.getElementById('drop-zone');
    const stopTTSBtn = document.getElementById('stop-tts');
    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');
    const forceWordlist = document.getElementById('force-wordlist');
    const hint = document.getElementById('hint');

    // events
    processBtn.addEventListener('click', handleProcessRequest);
    startOverBtn.addEventListener('click', resetUI);
    expandAllBtn.addEventListener('click', () => toggleAll(true));
    collapseAllBtn.addEventListener('click', () => toggleAll(false));
    stopTTSBtn.addEventListener('click', () => speechSynthesis.cancel());

    fileUpload.addEventListener('change', (e) => {
      const f = e.target.files[0]; if (f) handleFile(f);
    });

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault(); dropZone.classList.remove('drag-over');
      const f = e.dataTransfer.files[0]; if (f) handleFile(f);
    });

    uiLangSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));
    forceWordlist.addEventListener('change', syncLevelRequirement);
    textInput.addEventListener('input', syncLevelRequirement);

    function resetUI(){
      resultsView.classList.add('hidden');
      setupView.classList.remove('hidden');
      textInput.value=''; fileUpload.value=''; fileNameEl.textContent=''; resultsList.innerHTML='';
      hideError();
    }

    function handleFile(file){
      fileNameEl.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        const raw = e.target.result || '';
        textInput.value = file.name.endsWith('.srt') ? cleanSRT(raw) : raw;
        syncLevelRequirement();
      };
      reader.readAsText(file);
    }

    function cleanSRT(s){
      return s
        .replace(/\uFEFF/g,'')
        .replace(/^\d+\s*$/gm,'')
        .replace(/\d{2}:\d{2}:\d{2},\d{3}\s+-->\s+\d{2}:\d{2}:\d{2},\d{3}.*/g,'')
        .replace(/<[^>]+>/g,'')
        .replace(/[^\S\r\n]+/g,' ')
        .replace(/\n{2,}/g,'\n')
        .trim();
    }

    function looksLikeWordList(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
      if (lines.length>=2 && lines.every(l=>l.trim().length<=40)) return true;
      const tokens = text.split(/\s*-\s*/).filter(t=>t.trim()!=='');
      if (tokens.length>=2 && tokens.every(t=>t.trim().length<=40)) return true;
      const wc = text.trim().split(/\s+/).length;
      return wc<30 && !text.includes('\n\n');
    }

    function syncLevelRequirement(){
      const t = textInput.value.trim();
      const fileAttached = !!fileUpload.files[0];
      const autoIsList = looksLikeWordList(t) && !fileAttached;
      const isList = forceWordlist.checked || autoIsList;
     
      if (isList){
        userLevelSelect.value='Unspecified';
        userLevelSelect.disabled = true;
        hint.innerHTML = 'ğŸ“ Ø­Ø§Ù„Øª Â«Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡Â»: Ù‡Ø± Ø®Ø· ÛŒÚ© ÙˆØ§Ú˜Ù‡/Ø¹Ø¨Ø§Ø±Øª ÛŒØ§ Ø¨Ø§ <b>-</b> Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯. Ø³Ø·Ø­ Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª.';
      }else{
        userLevelSelect.disabled = false;
        hint.innerHTML = 'ğŸ“š Ø­Ø§Ù„Øª Â«Ù…ØªÙ†/ÙØ§ÛŒÙ„Â»: Ù„Ø·ÙØ§Ù‹ Ø³Ø·Ø­ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ ÙˆØ§Ú˜Ú¯Ø§Ù† Ùˆ Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚ Ø³Ø·Ø­ Ø´Ù…Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´ÙˆÙ†Ø¯.';
      }
    }

    function showError(m){ errorMsg.textContent=m; errorMsg.classList.remove('hidden'); }
    function hideError(){ errorMsg.classList.add('hidden'); }

    function handleProcessRequest(){
      const text = textInput.value.trim();
      const level = userLevelSelect.value;
      const fileAttached = !!fileUpload.files[0];
      const isList = forceWordlist.checked || (looksLikeWordList(text) && !fileAttached);

      if (!text){ showError(uiStrings[currentLang].errorText); return; }
      if (!isList && level==='Unspecified'){
        showError(uiStrings[currentLang].errorLevel); return;
      }

      hideError(); setupView.classList.add('hidden'); resultsView.classList.remove('hidden');
      loader.classList.remove('hidden'); resultsList.innerHTML='';
      callAI(text, isList);
    }

    function buildPrompt(text, isWordList){
      const sourceLang = sourceLangSelect.value;
      const targetLang = targetLangSelect.value;
      const level = userLevelSelect.value;

      const taskDesc = isWordList
        ? `You will analyze a USER-PROVIDED LIST of words/phrases in ${targetLang}. Items are either one per line or separated by hyphens "-". For EACH item, produce a full analysis.`
        : `You will analyze a LONG TEXT in ${targetLang}. Extract ALL useful, natural, everyday words, idioms, and set phrases appropriate for a ${level} learner. Do NOT limit the number of itemsâ€”focus on practical usefulness. For EACH extracted item, produce a full analysis.`;

      const fieldSpec =
`For EACH item, output EXACTLY the following template. Use "---" as a separator between items.
Do NOT add any text before the first item or after the last item.

Word: [the item in ${targetLang}]
Translation: [translation in ${sourceLang}; if multiple common meanings, separate with ";"]
Definition: [simple, level-appropriate definition in ${targetLang}]
Grammar: [part of speech; optionally sub-features like "phrasal verb (inseparable)", "verb (takes Akkusativ)", "noun (countable)"]
Collocations: [common combinations, comma-separated; if truly none, write "N/A"]
Examples:
1. [Example 1 in ${targetLang}] - [${sourceLang} translation]
2. [Example 2 in ${targetLang}] - [${sourceLang} translation]
3. [Optional more examples...]
Common Mistakes: ["nothing specific" OR a concrete pitfall (wrong preposition, word order, false friend, article/case)]
Context/Note:
- Write 1â€“2 concise sentences covering at least ONE of the following (choose the most relevant):
  register/formality; synonym contrast and subtle meaning; required prepositions or case governance;
  language-specific behavior (e.g., separable verb; phrasal-verb type; aspect; measure word/classifier; vowel harmony; clitic placement; liaison; gender/article);
  fixed expression constraints; typical contexts/frequency; a short pronunciation tip if truly useful.
- Never output "N/A" for this field. If nothing obvious applies, write: "neutral register; general-use".
Pronunciation: [IPA/Pinyin/phonetic if applicable; else "N/A"]
Tags:
- Choose 1â€“3 tags from the controlled list below (AT LEAST ONE tag is required).
- Use lowercase; hyphen for multiword; separate with semicolons (e.g., "informal;phrasal-verb").
- Allowed: informal; formal; neutral; spoken; academic; business; travel; tech; slang;
  idiom; phrasal-verb; collocation; fixed-expression; false-friend;
  grammar; pronunciation; register; preposition; case; separable; aspect; measure-word;
  gender; article; tense; frequency-high; frequency-medium; frequency-low; level-a1; level-a2; level-b1; level-b2; level-c1
---`;

      const extraRules = isWordList
        ? `INPUT MODE: WORD LIST. Treat each line or hyphen-separated token as ONE item.`
        : `INPUT MODE: LONG TEXT. "Example 1" MUST be the EXACT sentence from the source text.
Add 2â€“4 additional natural examples you create to cover different senses/usages if needed.
If the item is too basic/common OR too technical/rare for ${level}, SKIP it.`;

      return `
You are an expert language tutor AI.
User's native language: ${sourceLang}.
Target language: ${targetLang}.
${isWordList ? 'Proficiency is not specified for word-list mode.' : `User proficiency: ${level}.`}

${taskDesc}

Quality rules:
- Prioritize PRACTICAL everyday usage.
- If an item has multiple common meanings/usages, include them via translations and examples.
- No fixed limits: include as many items/examples as necessary if important.
- Output MUST strictly follow the template below. Do NOT add headers or prose.

${fieldSpec}

${extraRules}

${isWordList ? `Here is the word/phrase list:\n${text}` : `Here is the text to analyze:\n${text}`}
`.trim();
    }

    async function callAI(text, isWordList){
      const prompt = buildPrompt(text, isWordList);
      try{
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), 60000);
        const res = await fetch(PROXY_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt }),
          signal: controller.signal
        });
        clearTimeout(timeout);
        if(!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
        const data = await res.json();

        const ai =
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          data?.output_text || data?.text || '';
        if(!ai){ resultsList.innerHTML = `<p class="p-8 text-center text-red-600">${uiStrings[currentLang].errorAIResponse}</p>`; return; }

        renderResults(ai);
      }catch(err){
        console.error(err);
        resultsList.innerHTML = `<p class="p-8 text-center text-red-600">${uiStrings[currentLang].errorServer}</p>`;
      }finally{
        loader.classList.add('hidden');
      }
    }

    function parseAIResponse(s){
      const items = s.split('---').filter(x=>x.trim()!=='');
      return items.map(txt=>{
        const data = {};
        let currentKey = '';
        const lines = txt.trim().split('\n');

        lines.forEach(line => {
            const match = line.match(/^([a-zA-Z\s/]+):\s*(.*)/);
            if (match) {
                currentKey = match[1].trim().toLowerCase().replace(/[\s/]/g, '');
                data[currentKey] = match[2].trim();
            } else if (currentKey === 'examples' && /^\d+\./.test(line.trim())) {
                data.exampleslist = data.exampleslist || [];
                data.exampleslist.push(line.trim());
            } else if (currentKey === 'contextnote' && line.trim().startsWith('-')) {
                data[currentKey] += '\n' + line.trim();
            }
        });
        return data;
      });
    }

    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function getLangCode(name){
      const map={'English':'en-US','German':'de-DE','French':'fr-FR','Spanish':'es-ES','Italian':'it-IT','Russian':'ru-RU','Turkish':'tr-TR','Chinese':'zh-CN','Persian':'fa-IR'};
      return map[name]||'en-US';
    }

    function speakText(ev, text, langCode){
      ev?.stopPropagation?.();
      if(!text) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = langCode; speechSynthesis.speak(u);
    }

    function tagPaletteClass(i){
      const arr = ['tag-palette-1','tag-palette-2','tag-palette-3','tag-palette-4','tag-palette-5'];
      return arr[i % arr.length];
    }
 
    function renderResults(ai){
        const parsed = parseAIResponse(ai);

        const targetLangName = targetLangSelect.value;
        const targetIsRTL = ['Persian','Arabic','Urdu'].includes(targetLangName); // Simple RTL check
        resultsList.dir = targetIsRTL ? 'rtl' : 'ltr';

        const sourceLangName = sourceLangSelect.value;
        const strings = uiStrings[langNameToCode[sourceLangName]] || uiStrings.en;
        const isEmpty = parsed.length === 0 || parsed.every(x => !x.word);
        const targetLangCode = getLangCode(targetLangName);

        if (isEmpty){
            resultsList.innerHTML = `<div class="card p-8 text-center text-gray-600">${strings.errorNoResults}</div>`;
            return;
        }

        let html = '';
        parsed.forEach((it, idx)=>{
            const word = escapeHTML(it.word || '');
            const translation = escapeHTML(it.translation || '');
            const definition = escapeHTML(it.definition || 'N/A');
            const grammar = escapeHTML(it.grammar || 'N/A');
            const collocRaw = (it.collocations || '').split(/,|ØŒ/).map(s => s.trim()).filter(Boolean);
            const mistakes = escapeHTML(it.commonmistakes || 'N/A');
            const rawNote = (it.contextnote || 'N/A');
            const noteIsNA = /^n\/?a$/i.test(rawNote.trim()) || rawNote.trim()==='N/A';
            const note = noteIsNA ? '' : escapeHTML(rawNote).replace(/\n/g, '<br>');
            const pron = escapeHTML(it.pronunciation || 'N/A');
            const tagsRaw = (it.tags || '').split(';').map(s=>s.trim()).filter(Boolean);

            html += `
            <div class="result-item card">
                <div class="result-header flex justify-between items-center" onclick="toggleDetails(${idx})" aria-expanded="false" id="hdr-${idx}">
                    <div class="min-w-0">
                        <div class="flex items-center gap-3">
                            <h3 class="text-xl font-bold text-blue-700 truncate">${word || strings.wordNotFound}</h3>
                            ${grammar && grammar !== 'N/A' ? `<span class="chip">${grammar}</span>` : ''}
                        </div>
                        <p class="text-gray-700 mt-1">${translation}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-secondary p-2.5" onclick="speakText(event,'${word.replace(/'/g, "\\'")}', '${targetLangCode}')" title="${strings.speakWord}" aria-label="${strings.speakWord}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                        </button>
                        <span id="chevron-${idx}" class="text-2xl transition-transform text-gray-400">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </span>
                    </div>
                </div>
                <div id="details-${idx}" class="result-details bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span>ğŸ“˜</span><strong class="font-semibold">${strings.definition}:</strong>
                            </div>
                            <p class="text-gray-800 ps-8">${definition}</p>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-2"><span>ğŸ—£ï¸</span><strong class="font-semibold">${strings.pronunciation}:</strong></div>
                            <p class="text-gray-800 ps-8">${pron}</p>
                        </div>
                        <div class="md:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span>ğŸ”—</span><strong class="font-semibold">${strings.collocations}:</strong>
                            </div>
                            <div class="flex flex-wrap gap-2 ps-8">
                                ${collocRaw.length ? collocRaw.map((c,i) => `<span class="chip ${'tag-palette-'+((i%5)+1)}">${escapeHTML(c)}</span>`).join('') : `<span class="text-gray-500 text-sm">${strings.notApplicable}</span>`}
                            </div>
                        </div>
                         <div class="md:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span>ğŸ·ï¸</span><strong class="font-semibold">${strings.tags}:</strong>
                            </div>
                            <div class="flex flex-wrap gap-2 ps-8">
                                ${tagsRaw.length ? tagsRaw.map((t,i) => `<span class="chip tag ${tagPaletteClass(i)}">${escapeHTML(t)}</span>`).join('') : `<span class="text-gray-500 text-sm">${strings.notApplicable}</span>`}
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span>âœï¸</span><strong class="font-semibold">${strings.examples}:</strong>
                            </div>
                            <ul class="space-y-3 ${targetIsRTL ? 'pr-8' : 'pl-8'}">
                                ${(it.exampleslist || []).map(ex => {
                                    const splitAt = ex.lastIndexOf(' - ');
                                    let original = ex; let trans = '';
                                    if (splitAt > 1) { original = ex.slice(0, splitAt); trans = ex.slice(splitAt + 3); }
                                    original = original.replace(/^\d+\.\s*/, '').trim();
                                    return `<li>
                                        <div class="flex items-center gap-2">
                                            <p>${escapeHTML(original)}</p>
                                            <button class="btn btn-secondary p-2" onclick="speakText(event,'${original.replace(/'/g, "\\'")}', '${targetLangCode}')" title="${strings.speakSentence}" aria-label="${strings.speakSentence}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                                            </button>
                                        </div>
                                        ${trans ? `<p class="text-sm muted">${escapeHTML(trans.trim())}</p>` : ''}
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>
                        <div>
                           <div class="flex items-center gap-2 mb-2"><span>âš ï¸</span><strong class="font-semibold">${strings.commonMistakes}:</strong></div>
                           <p class="text-gray-800 ps-8">${mistakes}</p>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-2"><span>ğŸ’¡</span><strong class="font-semibold">${strings.contextNote}:</strong></div>
                            ${ note
                                ? `<p class="text-gray-800 ps-8">${note}</p>`
                                : `<div class="ps-8 text-sm text-gray-500 flex items-center gap-2">
                                     <span>â€”</span>
                                     <span>Ù†Ú©ØªÙ‡â€ŒØ§ÛŒ ØªÙˆØ³Ø· Ù…Ø¯Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù†Ø´Ø¯.</span>
                                   </div>` }
                        </div>
                    </div>
                </div>
            </div>`;
        });
        resultsList.innerHTML = html;
    }

    function toggleDetails(i){
      const d = document.getElementById(`details-${i}`);
      const c = document.getElementById(`chevron-${i}`);
      const h = document.getElementById(`hdr-${i}`);
      const nowOpen = !d.classList.contains('open');
      d.classList.toggle('open');
      if (c) c.style.transform = nowOpen ? 'rotate(180deg)' : 'rotate(0deg)';
      h.setAttribute('aria-expanded', nowOpen ? 'true':'false');
    }

    function toggleAll(open){
      const items = document.querySelectorAll('.result-details');
      items.forEach((d,idx)=>{
        const c = document.getElementById(`chevron-${idx}`);
        const h = document.getElementById(`hdr-${idx}`);
        if(h) h.setAttribute('aria-expanded', open ? 'true':'false');
        if(c) c.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
        if (open) { d.classList.add('open'); } else { d.classList.remove('open'); }
      });
    }

    let currentLang='fa';
    const langNameToCode = {'Persian':'fa','English':'en','German':'de','French':'fr','Spanish':'es','Chinese':'zh','Turkish':'tr','Italian':'it','Russian':'ru'};
    const uiStrings = {
        fa: {
            appTitle: "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø²Ø¨Ø§Ù† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ", mainTitle: "Ø³Ø§Ø²Ù†Ø¯Ù‡ ÙˆØ§Ú˜Ú¯Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯",
            subtitle: "Ø²Ø¨Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ Ù…ØªÙ† ÛŒØ§ ÙÙ‡Ø±Ø³Øª ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.",
            sourceLangLabel: "Ø²Ø¨Ø§Ù† Ù…Ø§Ø¯Ø±ÛŒ Ù…Ù†", targetLangLabel: "Ø²Ø¨Ø§Ù†ÛŒ Ú©Ù‡ ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…", userLevelLabel: "Ø³Ø·Ø­ Ù…Ù† (Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†/ÙØ§ÛŒÙ„)",
            levelUnspecified: "Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡", levelA1: "A1 (Ù…Ø¨ØªØ¯ÛŒ)", levelA2: "A2 (Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ)", levelB1: "B1 (Ù…ØªÙˆØ³Ø·)", levelB2: "B2 (ÙÙˆÙ‚ Ù…ØªÙˆØ³Ø·)", levelC1: "C1 (Ù¾ÛŒØ´Ø±ÙØªÙ‡)",
            uploadBtnText: "Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„", processBtn: "ØªØ­Ù„ÛŒÙ„ Ú©Ù†", resultsTitle: "Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„", startOverBtn: "Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡",
            errorLevel: "Ø¨Ø±Ø§ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§/ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù„Ø·ÙØ§Ù‹ Ø³Ø·Ø­ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ø®Ø±ÙˆØ¬ÛŒ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§Ø´Ø¯.", errorText: "Ù„Ø·ÙØ§Ù‹ ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ ÛŒØ§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.",
            errorAIResponse: "Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.", errorServer: "Ù…Ø´Ú©Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", errorNoResults: "Ù…ÙˆØ±Ø¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ø› ÙˆØ±ÙˆØ¯ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.",
            wordNotFound: "Ú©Ù„Ù…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯", definition: "ØªØ¹Ø±ÛŒÙ", grammar: "Ù†ÙˆØ¹ Ú¯Ø±Ø§Ù…Ø±", collocations: "ØªØ±Ú©ÛŒØ¨â€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒØ¬", examples: "Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§",
            commonMistakes: "Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª Ø±Ø§ÛŒØ¬", contextNote: "Ù†Ú©ØªÙ‡", pronunciation: "ØªÙ„ÙØ¸", forceWordlistLabel: "Ø§ÛŒÙ† ÙˆØ±ÙˆØ¯ÛŒ ÛŒÚ© Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡ Ø§Ø³Øª",
            hintStatic: "ğŸ’¡ Ø­Ø§Ù„Øª Â«Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡Â»: Ù‡Ø± Ø®Ø· ÛŒÚ© ÙˆØ§Ú˜Ù‡/Ø¹Ø¨Ø§Ø±Øª ÛŒØ§ Ø¨Ø§ <code>-</code> Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯. Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ù„Ø§Ø²Ù… Ù†ÛŒØ³Øª.<br>Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…ØªÙ† ÛŒØ§ ÙØ§ÛŒÙ„ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ØŒ Ø³ÛŒØ³ØªÙ… ÙˆØ§Ú˜Ú¯Ø§Ù† Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.",
            textPlaceholder: "Ù„ÛŒØ³Øª ÙˆØ§Ú˜Ù‡ (Ù‡Ø± Ø®Ø· ÛŒÚ© Ù…ÙˆØ±Ø¯) ÛŒØ§ Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„â€¦",
            expandAll: "Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡", collapseAll: "Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡", speakWord: "Ø´Ù†ÛŒØ¯Ù† ÙˆØ§Ú˜Ù‡", speakSentence: "Ø´Ù†ÛŒØ¯Ù† Ø¬Ù…Ù„Ù‡", stopSpeech: "ØªÙˆÙ‚Ù Ú¯ÙØªØ§Ø±",
            notApplicable: "Ù…ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", tags: "Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§",
            footerText: "Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
        },
        en: {
            appTitle: "AI Language Learner", mainTitle: "Smart Vocabulary Builder",
            subtitle: "Select your languages and enter a word list or a long text.", sourceLangLabel: "My Native Language",
            targetLangLabel: "Language I'm Learning", userLevelLabel: "My Level (for text/files)", levelUnspecified: "Unspecified",
            levelA1: "A1 (Beginner)", levelA2: "A2 (Elementary)", levelB1: "B1 (Intermediate)", levelB2: "B2 (Upper-Intermediate)", levelC1: "C1 (Advanced)",
            uploadBtnText: "Upload File", processBtn: "Analyze", resultsTitle: "Analysis Results", startOverBtn: "Start Over",
            errorLevel: "For texts/files, please select your level.", errorText: "Please enter or upload valid input.", errorAIResponse: "No valid AI response.",
            errorServer: "Problem connecting to server. Try again.", errorNoResults: "No items found. Try another input.", wordNotFound: "Word not found",
            definition: "Definition", grammar: "Grammar", collocations: "Collocations", examples: "Examples", commonMistakes: "Common Mistakes", contextNote: "Context/Note",
            pronunciation: "Pronunciation", forceWordlistLabel: "This input is a word list",
            hintStatic: "ğŸ’¡ 'Word List' mode: one word/phrase per line or separated with <code>-</code>. Level selection is not needed.<br>Otherwise, by pasting text or uploading a file and selecting your level, the system will extract practical vocabulary for you.",
            textPlaceholder: "Word list (one item per line) or long text for analysis...",
            expandAll: "Expand All", collapseAll: "Collapse All", speakWord: "Speak word", speakSentence: "Speak sentence", stopSpeech: "Stop speech",
            notApplicable: "Not Applicable", tags: "Tags",
            footerText: "Built with AI collaboration"
        },
        de: {appTitle:"KI-Sprachlerner",mainTitle:"Intelligenter Vokabeltrainer",subtitle:"Wortliste oder langen Text eingeben.",sourceLangLabel:"Meine Muttersprache",targetLangLabel:"Sprache, die ich lerne",userLevelLabel:"Mein Niveau (fÃ¼r Text/Dateien)",levelUnspecified:"Nicht angegeben",levelA1:"A1 (AnfÃ¤nger)",levelA2:"A2 (Grundlegend)",levelB1:"B1 (Mittelstufe)",levelB2:"B2 (Obere Mittelstufe)",levelC1:"C1 (Fortgeschritten)",uploadBtnText:"Datei hochladen",processBtn:"Analysieren",resultsTitle:"Analyseergebnisse",startOverBtn:"Neu anfangen",errorLevel:"FÃ¼r Texte/Dateien bitte Niveau wÃ¤hlen.",errorText:"Bitte gÃ¼ltige Eingabe eingeben/hochladen.",errorAIResponse:"Keine gÃ¼ltige KI-Antwort.",errorServer:"Verbindungsproblem. Erneut versuchen.",errorNoResults:"Keine Elemente gefunden.",wordNotFound:"Wort nicht gefunden",definition:"Definition",grammar:"Grammatik",collocations:"Kollokationen",examples:"Beispiele",commonMistakes:"HÃ¤ufige Fehler",contextNote:"Kontext/Notiz",pronunciation:"Aussprache",forceWordlistLabel:"Dies ist eine Wortliste",textPlaceholder:"Wortliste (ein Eintrag pro Zeile) oder langer Text...",expandAll:"Alle erweitern",collapseAll:"Alle reduzieren",speakWord:"Wort sprechen",speakSentence:"Satz sprechen",stopSpeech:"Sprache stoppen",notApplicable:"Nicht zutreffend", tags:"Tags", footerText:"Erstellt mit KI-Kollaboration"},
        fr: {appTitle:"Apprentissage des langues par l'IA",mainTitle:"Constructeur de vocabulaire intelligent",subtitle:"Saisissez une liste de mots ou un long texte.",sourceLangLabel:"Ma langue maternelle",targetLangLabel:"Langue que j'apprends",userLevelLabel:"Mon niveau (pour textes/fichiers)",levelUnspecified:"Non spÃ©cifiÃ©",levelA1:"A1 (DÃ©butant)",levelA2:"A2 (Ã‰lÃ©mentaire)",levelB1:"B1 (IntermÃ©diaire)",levelB2:"B2 (IntermÃ©diaire supÃ©rieur)",levelC1:"C1 (AvancÃ©)",uploadBtnText:"TÃ©lÃ©charger",processBtn:"Analyser",resultsTitle:"RÃ©sultats de l'analyse",startOverBtn:"Recommencer",errorLevel:"Pour textes/fichiers, choisissez votre niveau.",errorText:"Veuillez saisir ou tÃ©lÃ©charger une entrÃ©e valide.",errorAIResponse:"Aucune rÃ©ponse valide.",errorServer:"ProblÃ¨me de connexion.",errorNoResults:"Aucun Ã©lÃ©ment trouvÃ©.",wordNotFound:"Mot non trouvÃ©",definition:"DÃ©finition",grammar:"Grammaire",collocations:"Collocations",examples:"Exemples",commonMistakes:"Erreurs courantes",contextNote:"Contexte/Note",pronunciation:"Prononciation",forceWordlistLabel:"Ceci est une liste de mots",textPlaceholder:"Liste de mots (un par ligne) ou texte long...",expandAll:"Tout dÃ©plier",collapseAll:"Tout replier",speakWord:"Parler le mot",speakSentence:"Parler la phrase",stopSpeech:"ArrÃªter la parole",notApplicable:"Non applicable", tags:"Ã‰tiquettes", footerText:"CrÃ©Ã© avec la collaboration de l'IA"},
        es: {appTitle:"Aprendizaje de idiomas con IA",mainTitle:"Constructor de vocabulario inteligente",subtitle:"Lista de palabras o texto largo.",sourceLangLabel:"Mi lengua materna",targetLangLabel:"Idioma que aprendo",userLevelLabel:"Mi nivel (para texto/archivos)",levelUnspecified:"No especificado",levelA1:"A1 (Principiante)",levelA2:"A2 (Elemental)",levelB1:"B1 (Intermedio)",levelB2:"B2 (Intermedio alto)",levelC1:"C1 (Avanzado)",uploadBtnText:"Subir archivo",processBtn:"Analizar",resultsTitle:"Resultados del anÃ¡lisis",startOverBtn:"Empezar de nuevo",errorLevel:"Para textos/archivos, elige tu nivel.",errorText:"Introduce o sube una entrada vÃ¡lida.",errorAIResponse:"Sin respuesta vÃ¡lida.",errorServer:"Problemas de conexiÃ³n.",errorNoResults:"No se encontraron elementos.",wordNotFound:"No se encontrÃ³ palabra",definition:"DefiniciÃ³n",grammar:"GramÃ¡tica",collocations:"Colocaciones",examples:"Ejemplos",commonMistakes:"Errores comunes",contextNote:"Contexto/Nota",pronunciation:"PronunciaciÃ³n",forceWordlistLabel:"Esta es una lista de palabras",textPlaceholder:"Lista de palabras (una por lÃ­nea) o texto largo...",expandAll:"Expandir todo",collapseAll:"Contraer todo",speakWord:"Decir palabra",speakSentence:"Decir frase",stopSpeech:"Detener voz",notApplicable:"No aplica", tags:"Etiquetas", footerText:"Hecho con colaboraciÃ³n de IA"},
        zh: {appTitle:"äººå·¥æ™ºèƒ½è¯­è¨€å­¦ä¹ å™¨",mainTitle:"æ™ºèƒ½è¯æ±‡æ„å»ºå™¨",subtitle:"è¾“å…¥å•è¯åˆ—è¡¨æˆ–é•¿æ–‡æœ¬ã€‚",sourceLangLabel:"æˆ‘çš„æ¯è¯­",targetLangLabel:"æˆ‘å­¦ä¹ çš„è¯­è¨€",userLevelLabel:"æˆ‘çš„æ°´å¹³ï¼ˆç”¨äºæ–‡æœ¬/æ–‡ä»¶ï¼‰",levelUnspecified:"æœªæŒ‡å®š",levelA1:"A1 (åˆå­¦è€…)",levelA2:"A2 (åˆçº§)",levelB1:"B1 (ä¸­çº§)",levelB2:"B2 (ä¸­é«˜çº§)",levelC1:"C1 (é«˜çº§)",uploadBtnText:"ä¸Šä¼ æ–‡ä»¶",processBtn:"åˆ†æ",resultsTitle:"åˆ†æç»“æœ",startOverBtn:"é‡æ–°å¼€å§‹",errorLevel:"å¯¹äºæ–‡æœ¬/æ–‡ä»¶è¯·é€‰æ‹©æ°´å¹³ã€‚",errorText:"è¯·è¾“å…¥æˆ–ä¸Šä¼ æœ‰æ•ˆè¾“å…¥ã€‚",errorAIResponse:"æ— æœ‰æ•ˆå“åº”ã€‚",errorServer:"è¿æ¥é—®é¢˜ã€‚",errorNoResults:"æœªæ‰¾åˆ°é¡¹ç›®ã€‚",wordNotFound:"æœªæ‰¾åˆ°å•è¯",definition:"å®šä¹‰",grammar:"è¯­æ³•",collocations:"æ­é…",examples:"ä¾‹å­",commonMistakes:"å¸¸è§é”™è¯¯",contextNote:"è¯­å¢ƒ/è¯´æ˜",pronunciation:"å‘éŸ³",forceWordlistLabel:"è¿™æ˜¯ä¸€ä¸ªå•è¯åˆ—è¡¨",textPlaceholder:"å•è¯åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€é¡¹ï¼‰æˆ–é•¿æ–‡æœ¬...",expandAll:"å…¨éƒ¨å±•å¼€",collapseAll:"å…¨éƒ¨æŠ˜å ",speakWord:"æœ—è¯»å•è¯",speakSentence:"æœ—è¯»å¥å­",stopSpeech:"åœæ­¢æœ—è¯»", notApplicable:"ä¸é€‚ç”¨", tags:"æ ‡ç­¾", footerText:"ä¸ AI åˆä½œå®Œæˆ"},
        tr: {appTitle:"Yapay Zeka ile Dil Ã–ÄŸrenimi",mainTitle:"AkÄ±llÄ± Kelime OluÅŸturucu",subtitle:"Kelime listesi veya uzun metin.",sourceLangLabel:"Ana Dilim",targetLangLabel:"Ã–ÄŸrendiÄŸim Dil",userLevelLabel:"Seviyem (metin/dosyalar iÃ§in)",levelUnspecified:"BelirtilmemiÅŸ",levelA1:"A1 (BaÅŸlangÄ±Ã§)",levelA2:"A2 (Temel)",levelB1:"B1 (Orta)",levelB2:"B2 (Orta-Ã¼stÃ¼)",levelC1:"C1 (Ä°leri)",uploadBtnText:"Dosya YÃ¼kle",processBtn:"Analiz Et",resultsTitle:"Analiz SonuÃ§larÄ±",startOverBtn:"Yeniden BaÅŸla",errorLevel:"Metin/dosyalar iÃ§in seviye seÃ§in.",errorText:"GeÃ§erli bir giriÅŸ girin/yÃ¼kleyin.",errorAIResponse:"GeÃ§erli yanÄ±t yok.",errorServer:"BaÄŸlantÄ± sorunu.",errorNoResults:"Ã–ÄŸe bulunamadÄ±.",wordNotFound:"Kelime bulunamadÄ±",definition:"TanÄ±m",grammar:"Gramer",collocations:"Birlikte KullanÄ±mlar",examples:"Ã–rnekler",commonMistakes:"YaygÄ±n Hatalar",contextNote:"BaÄŸlam/Not",pronunciation:"Telaffuz",forceWordlistLabel:"Bu bir kelime listesidir",textPlaceholder:"SatÄ±r baÅŸÄ±na bir kelime/ifade veya uzun metin...",expandAll:"TÃ¼mÃ¼nÃ¼ GeniÅŸlet",collapseAll:"TÃ¼mÃ¼nÃ¼ Daralt",speakWord:"Kelimeyi sÃ¶yle",speakSentence:"CÃ¼mleyi sÃ¶yle",stopSpeech:"KonuÅŸmayÄ± durdur", notApplicable:"Uygulanamaz", tags:"Etiketler", footerText:"AI iÅŸ birliÄŸiyle oluÅŸturuldu"},
        it: {appTitle:"Apprendimento delle lingue con IA",mainTitle:"Costruttore di vocabolario intelligente",subtitle:"Elenco parole o testo lungo.",sourceLangLabel:"Lingua madre",targetLangLabel:"Lingua che imparo",userLevelLabel:"Livello (per testi/file)",levelUnspecified:"Non specificato",levelA1:"A1 (Principiante)",levelA2:"A2 (Elementare)",levelB1:"B1 (Intermedio)",levelB2:"B2 (Intermedio-superiore)",levelC1:"C1 (Avanzato)",uploadBtnText:"Carica File",processBtn:"Analizza",resultsTitle:"Risultati dell'analisi",startOverBtn:"Ricomincia",errorLevel:"Per testi/file seleziona il livello.",errorText:"Inserisci/carica un input valido.",errorAIResponse:"Nessuna risposta valida.",errorServer:"Problema di connessione.",errorNoResults:"Nessun elemento trovato.",wordNotFound:"Parola non trovata",definition:"Definizione",grammar:"Grammatica",collocations:"Collocazioni",examples:"Esempi",commonMistakes:"Errori comuni",contextNote:"Contesto/Nota",pronunciation:"Pronuncia",forceWordlistLabel:"Questa Ã¨ una lista di parole",textPlaceholder:"Elenco parole (una per riga) o testo lungo...",expandAll:"Espandi tutto",collapseAll:"Comprimi tutto",speakWord:"Pronuncia parola",speakSentence:"Pronuncia frase",stopSpeech:"Ferma discorso", notApplicable:"Non applicabile", tags:"Tag", footerText:"Creato con la collaborazione dell'IA"},
        ru: {appTitle:"Ğ˜Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ·Ñ‹ĞºĞ¾Ğ² Ñ Ğ˜Ğ˜",mainTitle:"Ğ£Ğ¼Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ°ÑĞ°",subtitle:"Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ»Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚.",sourceLangLabel:"Ğ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑĞ·Ñ‹Ğº",targetLangLabel:"Ğ˜Ğ·ÑƒÑ‡Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº",userLevelLabel:"Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ (Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ°/Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²)",levelUnspecified:"ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½",levelA1:"A1 (ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ğ¹)",levelA2:"A2 (Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ½Ñ‹Ğ¹)",levelB1:"B1 (Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹)",levelB2:"B2 (Ğ’Ñ‹ÑˆĞµ ÑÑ€ĞµĞ´Ğ½ĞµĞ³Ğ¾)",levelC1:"C1 (ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹)",uploadBtnText:"Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»",processBtn:"ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",resultsTitle:"Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°",startOverBtn:"ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ°",errorLevel:"Ğ”Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ°/Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ.",errorText:"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ/Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.",errorAIResponse:"ĞĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ˜Ğ˜.",errorServer:"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ.",errorNoResults:"ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.",wordNotFound:"Ğ¡Ğ»Ğ¾Ğ²Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾",definition:"ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ",grammar:"Ğ“Ñ€Ğ°Ğ¼Ğ¼Ğ°Ñ‚Ğ¸ĞºĞ°",collocations:"Ğ¡Ğ¾Ñ‡ĞµÑ‚Ğ°Ğ½Ğ¸Ñ",examples:"ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹",commonMistakes:"Ğ§Ğ°ÑÑ‚Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸",contextNote:"ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚/ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ",pronunciation:"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ",forceWordlistLabel:"Ğ­Ñ‚Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ»Ğ¾Ğ²",textPlaceholder:"Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ»Ğ¾Ğ² (Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ) Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚...",expandAll:"Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ",collapseAll:"Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ",speakWord:"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ½ĞµÑÑ‚Ğ¸ ÑĞ»Ğ¾Ğ²Ğ¾",speakSentence:"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ½ĞµÑÑ‚Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ",stopSpeech:"ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµÑ‡ÑŒ", notApplicable:"ĞĞµĞ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾", tags:"Ğ¢ĞµĞ³Ğ¸", footerText:"Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ Ğ˜Ğ˜"}
    };

    function setLanguage(lang){
      currentLang = lang;
      const s = uiStrings[lang] || uiStrings.en;
      const isRtl = lang==='fa';
     
      document.documentElement.lang = lang;
      document.documentElement.dir = isRtl ? 'rtl':'ltr';
     
      document.getElementById('app-title').textContent = s.appTitle;
      document.getElementById('main-title').textContent = s.mainTitle;
      document.getElementById('subtitle').textContent = s.subtitle;
      document.getElementById('source-lang-label').textContent = s.sourceLangLabel;
      document.getElementById('target-lang-label').textContent = s.targetLangLabel;
      document.getElementById('user-level-label').textContent = s.userLevelLabel;
      document.getElementById('level-unspecified').textContent = s.levelUnspecified;
      document.getElementById('level-a1').textContent = s.levelA1;
      document.getElementById('level-a2').textContent = s.levelA2;
      document.getElementById('level-b1').textContent = s.levelB1;
      document.getElementById('level-b2').textContent = s.levelB2;
      document.getElementById('level-c1').textContent = s.levelC1;
      document.getElementById('upload-btn-text').textContent = s.uploadBtnText;

      const processBtnSpan = document.querySelector('#process-btn > span');
      if(processBtnSpan) processBtnSpan.textContent = s.processBtn;

      document.getElementById('results-title').textContent = s.resultsTitle;
      document.getElementById('start-over-btn').textContent = s.startOverBtn;
      document.getElementById('force-wordlist-label').textContent = s.forceWordlistLabel;
      document.getElementById('expand-all').textContent = "â¬‡ï¸ " + s.expandAll;
      document.getElementById('collapse-all').textContent = "â¬†ï¸ " + s.collapseAll;
      document.getElementById('stop-tts').title = s.stopSpeech;
      document.getElementById('text-input').placeholder = s.textPlaceholder;
      document.getElementById('hint').innerHTML = s.hintStatic;
      document.getElementById('footer-text').textContent = s.footerText || "Built with AI collaboration";
      syncLevelRequirement();
    }

    document.addEventListener('DOMContentLoaded', ()=> setLanguage('fa'));
  </script>
</body>
</html>

